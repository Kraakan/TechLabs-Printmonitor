<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dennis Printmonitor</title>
  <style>
    html, body {
    height: 100%;
    margin: 0;
    overflow-y: hidden;
}
p {
    font-size: xx-large;
    font-family: Arial, sans-serif;
  }
    </style>
</head>

<body>
  <!-- Prusa-server computer -->
  <img id="printerImage" src="http://192.168.1.42:5000/images/last" alt="Printer Image" style="width:720px;">
  <div id="printerStatus" >
    <p>
        <strong>Status: </strong><span id="printer-state"></span><br>
        <strong>Job: </strong>    <span id="job-file-display_name"></span><br>
        <strong>Progress: </strong> <span id="job-progress"></span> %<br>
        <strong>Remaining: </strong> <span id="job-time_remaining"></span> mins<br>
        <strong>Nozzle temp: </strong> <span id="printer-temp_nozzle"></span> C<br>
        <strong>Bed temp: </strong>    <span id="printer-temp_bed"></span> C<br>
        <strong>Z-height: </strong>   <span id="printer-axis_z"></span> mm<br>
    </p>
  </div>
</body>


<script>
function fetchPrinterImage() {
    fetch('http://192.168.1.42:5000/images/last') // Prusa server computer
    .then(response => {
        if (!response.ok) { throw new Error("Network error");  }
        return response.blob();
    })
    .then(blob => {
        const imageUrl = URL.createObjectURL(blob);
        document.querySelector("#printerImage").src = imageUrl;
    })
    .catch(error => { console.error('There was a problem with the fetch operation:', error);  });
}

// CORS redirection via localhost
async function fetchPrinterStatus() {
  try {
    const response = await fetch('http://127.0.0.1:5000/api/data');
    if (!response.ok) { throw new Error('Network response was not ok'); }
    // Wait for the promise to be resolved
    const data = await response.json(); 
    // console.log(data);
    document.querySelector("#printer-state").textContent = data.printer.state;
    document.querySelector("#printer-temp_nozzle").textContent = data.printer.temp_nozzle;
    document.querySelector("#printer-temp_bed").textContent = data.printer.temp_bed;
    document.querySelector("#printer-axis_z").textContent = data.printer.axis_z;
    if (data.job != undefined ) {
    document.querySelector("#job-progress").textContent = data.job.progress;
    document.querySelector("#job-file-display_name").textContent = data.display_name;
    document.querySelector("#job-time_remaining").textContent = data.job.time_remaining/60;
    } else {
        document.querySelector("#job-progress").textContent = "-";
        document.querySelector("#job-file-display_name").textContent = "No active job";
        document.querySelector("#job-time_remaining").textContent = "-";
    }
  } catch (error) { console.error('There was a problem with the fetch operation:', error);  }
}

// Fetch image every 10 seconds
setInterval(fetchPrinterImage, 10000);

// Fetch printer status every 10 seconds
setInterval(fetchPrinterStatus, 10000);
</script>

</html>